stages:
  - build
  - deploy # not ready too many bugs

# Change pip's cache directory to be inside the project directory since we can
# only cache local items.
variables:
  PIP_CACHE_DIR: "$CI_PROJECT_DIR/.cache/pip"
  CONDA_PACKAGE: "chisurf"

build:linux:
  stage: build
  tags:
    - linux
  image: continuumio/miniconda3:latest
  before_script:
    - apt-get update -qy
    # Make command
    - apt-get install -y build-essential
  script:
    - source activate
    - cp .condarc ~/.condarc
    - conda install mamba=$MAMBA_VERSION boa conda-verify
    - mamba install -y python=3.7
    - conda mambabuild conda-recipe --output-folder bld-dir
  artifacts:
    expire_in: 7 days
    paths:
      - bld-dir/

# deploy:
#   stage: deploy
#   image: continuumio/miniconda3:latest
#   tags:
#     - linux
#   dependencies:
#     - build:linux
#   script:
#     - source activate
#     - conda install anaconda-client
#     - if [[ "$CI_COMMIT_REF_NAME" == "master" ]]; then DEPLOY_LABEL=main; else DEPLOY_LABEL=nightly; fi
#     - anaconda -t ${ANACONDA_API_TOKEN} upload -l ${DEPLOY_LABEL} -u ${CONDA_USER} --force bld-dir/linux-64/*.tar.bz2
